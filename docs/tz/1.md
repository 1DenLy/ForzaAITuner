# Техническое Задание: Sprint #1 — "Walking Skeleton"

**Проект:** FH4 Telemetry Tuner

**Роль:** Backend / Data Engineering

**Дата:** 25.12.2025

**Статус:** В работе

---

## 1. Цель спринта

Создание базовой архитектуры ("ходячего скелета") системы сбора телеметрии. Реализация полного цикла данных (Pipeline): получение UDP пакета от игры *Forza Horizon 4*, десериализация, фильтрация бизнес-логикой и сохранение в реляционную базу данных PostgreSQL.

## 2. Стек технологий

* **Язык:** Python 3.11+
* **База данных:** PostgreSQL 15 (Alpine)
* **ORM:** SQLAlchemy 2.0+ (Async или Sync — на усмотрение, для воркера рекомендуется Sync для простоты multiprocessing в будущем)
* **Конфигурация:** Pydantic Settings / PyYAML
* **Инфраструктура:** Docker, Docker Compose
* **Сетевое взаимодействие:** `socket` (UDP/IP)

## 3. Архитектура и Модули

Проект должен следовать принципам Clean Architecture (слоистая архитектура).

### 3.1. Структура проекта (Package Layout)

```text
src/
├── core/           # Бизнес-сущности и интерфейсы
├── infrastructure/ # Работа с БД, Сокетами, Парсинг байтов
├── app/            # Use Cases, логика оркестрации (DataProcessor)
├── cmd/            # Точки входа (CLI, main scripts)
└── config/         # Настройки приложения
```

## 4. Требования к данным (Database Schema)

Необходимо реализовать следующие таблицы в PostgreSQL.

### 4.1. `cars` (Справочник автомобилей)

Заполняется вручную пользователем перед стартом сессии.

| Поле       | Тип          | Описание                                   |
| :--------- | :----------- | :----------------------------------------- |
| id         | Integer (PK) | Уникальный ID                              |
| name       | Varchar(255) | Название (напр. "Nissan Silvia S15 Drift") |
| created_at | DateTime     | Дата добавления                            |

---

### 4.2. `tuning_configs` (Конфигурации тюнинга)

Слепок настроек для конкретной машины.

| Поле        | Тип          | Описание                                   |
| :---------- | :----------- | :----------------------------------------- |
| id          | Integer (PK) | Уникальный ID                              |
| car_id      | Integer (FK) | Ссылка на `cars.id`                        |
| description | Text         | Описание (напр. "Мягкая подвеска, тест 1") |
| created_at  | DateTime     | Дата создания                              |

---

### 4.3. `race_sessions` (Сессия записи)

Один непрерывный процесс записи телеметрии (один заезд).

| Поле       | Тип          | Описание                      |
| :--------- | :----------- | :---------------------------- |
| id         | Integer (PK) | Уникальный ID                 |
| config_id  | Integer (FK) | Ссылка на `tuning_configs.id` |
| track_name | Varchar      | (Опционально) Название трассы |
| started_at | DateTime     | Время начала записи           |

---

### 4.4. `telemetry_frames` (Кадры телеметрии)

"Тяжелая" таблица с временными рядами.

| Поле          | Тип          | Описание                                                                                         |
| :------------ | :----------- | :----------------------------------------------------------------------------------------------- |
| id            | BigInt (PK)  | Идентификатор записи                                                                             |
| session_id    | Integer (FK) | Ссылка на `race_sessions.id`                                                                     |
| timestamp_ms  | Integer      | Время в мс от старта гонки (TimestampMS)                                                         |
| is_race_on    | Boolean      | Флаг активности гонки                                                                            |
| speed         | Float        | Скорость (м/с или км/ч)                                                                          |
| power         | Float        | Мощность                                                                                         |
| torque        | Float        | Крутящий момент                                                                                  |
| fl_suspension | Float        | Ход подвески FL (Front Left)                                                                     |
| fr_suspension | Float        | Ход подвески FR                                                                                  |
| rl_suspension | Float        | Ход подвески RL                                                                                  |
| rr_suspension | Float        | Ход подвески RR                                                                                  |
| ...           | ...          | Другие поля по необходимости (RPM, Gear, Brake, Throttle, Steering, WheelSpeed, Position и т.д.) |

> Рекомендация: индексировать `session_id`, `timestamp_ms` и поля, часто используемые в фильтрах/агрегациях.

## 5. Функциональные требования

### 5.1. Конфигурация (Configuration)

Система должна читать настройки из файла `config.yaml` или переменных окружения.

Параметры:

* `UDP_PORT` (default: 5300)
* `DB_URL` (строка подключения Postgres)
* `DOWNSAMPLING_ENABLED` (True/False)
* `DOWNSAMPLING_RATE` (Integer, напр. `2` — сохранять каждый второй пакет)

### 5.2. Модуль Ingestion (Сбор данных)

* **UDP Listener:** Должен биндиться на `0.0.0.0:UDP_PORT`.
* **Buffer Size:** Принимать буфер пакета (ожидается ~324 байта для FH4).

### 5.3. Парсинг (Parsing Strategy)

* Реализовать класс `FH4PacketParser`.
* Использовать библиотеку `struct` для распаковки бинарных данных.
* Структура данных "Data Out" (FH4):

  * `s32 IsRaceOn` (offset 0)
  * `u32 TimestampMS` (offset 4)
  * `f32 EngineMaxRpm` (offset 8)
  * ... (полную карту байтов см. в документации Forza Data Out)
* **Важно:** Парсер должен возвращать DTO (Pydantic-модель), а не сырой кортеж.

### 5.4. Логика обработки (Processor)

* **State Filter:** Проверять поле `IsRaceOn`.

  * Если `0` (пауза/меню) — пакет игнорируется, в БД не пишется.
  * Если `1` — пакет передается дальше.
* **Downsampling:**

  * Если включен — сохранять только каждый `N`-й пакет.
* **Buffering:**

  * Не делать INSERT на каждый пакет.
  * Накапливать данные в памяти (batch).
  * Сбрасывать в БД (`session.bulk_save_objects` или аналог) при достижении размера буфера (например, 100 записей) или при корректном завершении приложения.

### 5.5. CLI Интерфейс

Простой сценарий запуска через `main.py`:

1. Запрос ввода: "Имя машины?" -> Создание/Поиск в БД.
2. Запрос ввода: "Описание настройки?" -> Создание `tuning_config`.
3. Старт прослушивания UDP.
4. Вывод статуса в консоль: `"Waiting for race..."`, `"Recording (Frames: X)..."`.
5. Обработка `KeyboardInterrupt` (Ctrl+C) для корректного закрытия сессии и DB соединения (flush/batch save оставшихся записей).

## 6. Инфраструктура (Docker)

### 6.1. `docker-compose.yml`

Должен поднимать два сервиса:

* `db`: PostgreSQL. Прокинуть порт `5432`, настроить `volume` для персистентности данных.
* `app` (`telemetry-worker`): сборка из `Dockerfile`.

Требования:

* Проброс порта UDP: `5300:5300/udp`.
* `depends_on: - db`.
* Монтирование исходного кода (bind mount) для удобства разработки.

## 7. Критерии приемки (Definition of Done)

* [ ] Создан репозиторий с файловой структурой.
* [ ] Написан `docker-compose.yml`, контейнеры поднимаются без ошибок.
* [ ] БД инициализируется, таблицы создаются (через Alembic или `Base.metadata.create_all`).
* [ ] При запуске скрипта и запущенной игре Forza Horizon 4 данные поступают в систему.
* [ ] Данные корректно распаковываются (значения скорости и оборотов похожи на правду, а не случайный набор цифр).
* [ ] Работает фильтрация: пока машина в меню/паузы, записи в БД не добавляются.
* [ ] После завершения заезда в таблице `telemetry_frames` есть данные, связанные с `race_sessions`.
* [ ] Код соответствует PEP8.

---

## Примечания и рекомендации

* Для отладки полезно иметь separate utility, отправляющий тестовые UDP-пакеты (фиктивные или взятые из реального дампа) на `UDP_PORT`.
* Подумать о добавлении метрик (Prometheus) и логирования (structured logging) в следующих спринтах.
* Для больших объёмов данных в будущем рассмотреть TimescaleDB или партицирование по `session_id`/`timestamp_ms`.

*Конец ТЗ — Sprint #1 (Walking Skeleton).*
